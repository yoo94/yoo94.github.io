(_=>{function n(t){return t.replace(/^\//,"").replace(/\//g,"-")}function v(){_(".gh-search-item").each(function(){var t=this.getAttribute("id").replace(/^new-/,"");this.setAttribute("id",t)})}function i(){this.blogData={},this.latestPost=0;var t="/ghost/api/v2/content/posts/?key="+ghosthunter_key+"&limit=all&include=tags",s=(this.includebodysearch?t+="&formats=plaintext":0,this);_.get(t).done(function(t){var e=t.posts;s.index=lunr(function(){this.ref("id"),this.field("title"),this.field("description"),s.includebodysearch&&this.field("plaintext"),this.field("pubDate"),this.field("tag"),e.forEach(function(t){var e=new Date(t.updated_at).getTime(),e=(new Date(s.latestPost).getTime()<e&&(s.latestPost=t.updated_at),t.tags.map(function(t){return t.name})),i=(null==t.meta_description&&(t.meta_description=""),e.join(", ")),i=(i.length<1&&(i="undefined"),{id:String(t.id),title:String(t.title),description:String(t.custom_excerpt),pubDate:String(t.published_at),tag:i}),n=(s.includebodysearch&&(i.plaintext=String(t.plaintext)),this.add(i),s.subpath+t.url);s.blogData[t.id]={title:t.title,description:t.custom_excerpt,pubDate:(t=>(t=new Date(t)).getDate()+" "+["January","February","March","April","May","June","July","August","September","October","November","December"][t.getMonth()]+" "+t.getFullYear())(i.pubDate),link:n,tags:e},s.item_preprocessor&&Object.assign(s.blogData[t.id],s.item_preprocessor(t))},this)});try{var i=n(s.subpath);localStorage.setItem("ghost_"+i+"_lunrIndex",JSON.stringify(s.index)),localStorage.setItem("ghost_"+i+"_blogData",JSON.stringify(s.blogData)),localStorage.setItem("ghost_"+i+"_latestPost",s.latestPost)}catch(t){console.warn("ghostHunter: save to localStorage failed: "+t)}s.indexing_end&&s.indexing_end(),s.isInit=!0})}_.fn.ghostHunter=function(t){t=_.extend({},_.fn.ghostHunter.defaults,t);if(t.results)return e.init(this,t),e},_.fn.ghostHunter.defaults={resultsData:!1,onPageLoad:!1,onKeyUp:!1,result_template:"<a id='gh-{{ref}}' class='gh-search-item' href='{{link}}'><p><h2>{{title}}</h2><h4>{{pubDate}}</h4></p></a>",info_template:"<p>Number of posts found: {{amount}}</p>",displaySearchInfo:!0,zeroResultsInfo:!0,before:!1,onComplete:!1,filterfields:!1,subpath:"",item_preprocessor:!1,indexing_start:!1,indexing_end:!1,includebodysearch:!1,lunrOptions:{usePipeline:!0,tokenizer:lunr.ko.tokenizer}};var t=null,e={isInit:!1,init:function(e,t){var i=this;i.target=e,Object.assign(this,t),t.onPageLoad?window.setTimeout(function(){i.loadAPI()},1):e.focus(function(){i.loadAPI()}),e.closest("form").submit(function(t){t.preventDefault(),i.find(e.val())}),t.onKeyUp&&(e.keydown(function(t){if(13===t.which)return!1}),e.keyup(function(t){i.find(e.val())}))},loadAPI:function(){if(!this.isInit){this.indexing_start&&this.indexing_start();try{var t=n(this.subpath);this.index=localStorage.getItem("ghost_"+t+"_lunrIndex"),this.blogData=localStorage.getItem("ghost_"+t+"_blogData"),this.latestPost=localStorage.getItem("ghost_"+t+"_latestPost"),this.latestPost&&this.index&&this.blogData&&(this.latestPost=this.latestPost,this.index=lunr.Index.load(JSON.parse(this.index)),this.blogData=JSON.parse(this.blogData),this.isInit=!0)}catch(t){console.warn("ghostHunter: retrieve from localStorage failed: "+t)}}var e;this.isInit?(this.latestPost.replace(/\..*/,"").replace(/T/," "),t="/ghost/api/v2/content/posts/?key="+ghosthunter_key+"&limit=all&fields=id&filter=updated_at:>'"+this.latestPost.replace(/\..*/,"").replace(/T/," ")+"'",e=this,_.get(t).done(function(t){0<t.posts.length?i.call(e):(e.indexing_end&&e.indexing_end(),e.isInit=!0)})):i.call(this)},find:function(b){clearTimeout(t),b=(b=b||"").toLowerCase(),t=setTimeout(function(){for(var t=[],e=b.split(/\s+/),i=0,n=e.length;i<n;i++){var s=e[i];s&&t.push(this.index.query(function(t){t.term(s,{usePipeline:!0,boost:100}),t.term(s,{usePipeline:!1,boost:10,wildcard:lunr.Query.wildcard.TRAILING}),t.term(s,{usePipeline:!1,editDistance:1,boost:1})}))}if(1<t.length)for(var a=t[0],t=t.slice(1),i=a.length-1;-1<i;i--){var o=a[i].ref;for(j=0,jlen=t.length;j<jlen;j++){for(var r={},l=0,h=t[j].length;l<h;l++)r[t[j][l].ref]=!0;if(!r[o]){a=a.slice(0,i).concat(a.slice(i+1));break}}}else a=1===t.length?t[0]:[];var u=_(this.results),c=[];0===a.length?(u.empty(),this.displaySearchInfo&&this.zeroResultsInfo&&u.append(this.format(this.info_template,{amount:0}))):this.displaySearchInfo&&(0<u.length?u.children().eq(0).replaceWith(this.format(this.info_template,{amount:a.length})):u.append(this.format(this.info_template,{amount:a.length}))),this.before&&this.before();for(i=0;i<a.length;i++){var d=a[i].ref,g=this.blogData[d];g?(g.ref=d,c.push(g)):console.warn("ghostHunter: index/data mismatch. Ouch.")}var f=_(".gh-search-item"),p=f.map(function(){return this.id.slice(3)}).get();if(0===p.length){for(i=0,n=c.length;i<n;i++)u.append(this.format(this.result_template,c[i]));v()}else{for(var m=[],i=0,n=a.length;i<n;i++)m.push(a[i].ref);p=new Levenshtein(p,m).getSteps();!function(t,e,i){for(var n=0,s=i.length;n<s;n++){var a,o=i[n];"delete"==o[0]?t.eq(o[1]-1).remove():(a=e[o[2]-1].ref,a=this.blogData[a],a=this.format(this.result_template,a),"substitute"===o[0]?t.eq(o[1]-1).replaceWith(a):"insert"===o[0]&&(o=0===o[1]?null:o[1]-1,t.eq(o).after(a)))}v()}.call(this,f,a,p)}this.onComplete&&this.onComplete(c)}.bind(this),100)},clear:function(){_(this.results).empty(),this.target.val("")},format:function(t,i){return t.replace(/{{([^{}]*)}}/g,function(t,e){e=i[e];return"string"==typeof e||"number"==typeof e?e:t})}}})(jQuery);